# Marketing v2 Complete Guide

This guide provides comprehensive instructions for implementing, configuring, and using the marketing v2 module in the `ugc_dashboard`. The guide assumes you are familiar with Next.js, React, TypeScript, and Supabase.

## 1. Project Setup

Follow the steps in `docs/setup-local.md` to set up the project locally. Ensure that migrations and seed data are applied so that marketing tables and views exist in the database.

## 2. Database Schema

### Tables

1. `marketing_campaigns`: Base table for all marketing campaigns.
2. `offline_events`: Stores details about offline marketing events.
3. `seo_sem_campaigns`: Contains keyword‑level metrics for SEO/SEM efforts.
4. `website_analytics`: Daily website traffic metrics.
5. `digital_channels`: Aggregated data for digital channels.
6. `content_pieces`: Metadata and performance of marketing content.
7. `marketing_attribution`: Aggregated attribution metrics by channel and date.

### Views

* `v_marketing_overview`: Summarizes high‑level KPIs such as total leads, total spend, cost per lead, ROI, and conversions by channel.
* `v_offline_event_stats`: Aggregates offline events by month or campaign for trending charts.
* `v_seo_sem_summary`: Aggregates SEO/SEM metrics across keywords and campaigns.
* `v_content_performance`: Summarizes impressions and leads generated by content pieces.
* `v_attribution_models`: Computes first‑touch, last‑touch, and assisted conversions per channel.

### Policies

Ensure that RLS policies in `supabase/policies/1300_rls_marketing_v2.sql` are applied. These policies restrict access to marketing tables based on the user’s role and permissions (e.g., `read_marketing_data`, `manage_marketing_data`).

## 3. API Routes

All marketing APIs live under `/app/api/marketing`. Each file exports a default `async` function handling the request. Use the Supabase service role to query data but perform RBAC checks first.

### Example: `/app/api/marketing/offline-events/route.ts`

```ts
import { NextRequest, NextResponse } from 'next/server';
import { createSupabaseServerClient } from '@/lib/supabase/server';
import { authorize } from '@/lib/rbac/authorize';

export async function GET(req: NextRequest) {
  const { user, supabase } = await createSupabaseServerClient(req);
  if (!await authorize(user, 'read_marketing_data')) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });
  }
  const { searchParams } = new URL(req.url);
  const from = searchParams.get('from');
  const to = searchParams.get('to');
  const { data, error } = await supabase
    .from('offline_events')
    .select('*')
    .gte('event_date', from)
    .lte('event_date', to)
    .order('event_date', { ascending: false });
  if (error) {
    console.error('Error fetching offline events:', error);
    return NextResponse.json({ error: 'Failed to fetch events' }, { status: 500 });
  }
  return NextResponse.json(data);
}

export async function POST(req: NextRequest) {
  const { user, supabase } = await createSupabaseServerClient(req);
  if (!await authorize(user, 'manage_offline_events')) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });
  }
  const body = await req.json();
  const { data, error } = await supabase
    .from('offline_events')
    .insert([{ ...body, created_by: user?.id }])
    .single();
  if (error) {
    console.error('Error creating offline event:', error);
    return NextResponse.json({ error: 'Failed to create event' }, { status: 500 });
  }
  return NextResponse.json(data, { status: 201 });
}
```

Repeat similar patterns for each marketing API route (SEO/SEM campaigns, website analytics, digital channels, content pieces, attribution, KPI).

## 4. React Components

Components for marketing v2 reside under `components/marketing`. Each component focuses on a specific sub‑module and uses hooks and UI primitives to render data.

### Example: `OfflineEventsPanel.tsx`

```tsx
import { useEffect, useState } from 'react';
import { FilterBar } from '@/components/filters/FilterBar';
import { KpiCard } from '@/components/dashboard/KpiCard';
import { TrendChart } from '@/components/dashboard/TrendChart';
import { DataTable } from '@/components/dashboard/DataTable';
import { OfflineEventForm } from '@/components/forms/OfflineEventForm';

export default function OfflineEventsPanel() {
  const [events, setEvents] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Fetch events based on filters
  useEffect(() => {
    async function fetchEvents() {
      setLoading(true);
      const params = new URLSearchParams(window.location.search);
      const from = params.get('from');
      const to = params.get('to');
      const res = await fetch(`/app/api/marketing/offline-events?from=${from}&to=${to}`);
      if (!res.ok) {
        setError('Failed to load events');
        setLoading(false);
        return;
      }
      const data = await res.json();
      setEvents(data);
      setLoading(false);
    }
    fetchEvents();
  }, [window.location.search]);

  return (
    <section className="space-y-6">
      <FilterBar />
      <KpiCard title="Total Events" value={events.length.toString()} />
      <TrendChart data={events} xKey="event_date" yKey="leads_generated" />
      <DataTable data={events} columns={[{ key: 'event_name', header: 'Event' }, { key: 'location', header: 'Location' }, { key: 'attendees', header: 'Attendees' }, { key: 'leads_generated', header: 'Leads' }]} loading={loading} error={error} />
      <OfflineEventForm onCreated={() => window.location.reload()} />
    </section>
  );
}
```

### Tabs & Navigation

The `MarketingTabs` component wraps each panel in a tabbed interface. On mobile screens, tabs collapse into an accordion. Use the `Tabs` primitive from `components/ui`.

## 5. RBAC & Permissions

Define marketing‑related permissions in the seed scripts (e.g., `manage_offline_events`, `read_marketing_data`). Assign these permissions to the marketing role via the `role_permissions` table. The `usePermissions` hook fetches the current user’s permissions so that UI elements can be conditionally rendered.

## 6. Filtering & Presets

Use the `useFilterState` hook to synchronize filters between the URL and local storage. When a user changes the date range or selects a campaign, the hook updates the query string. The `FilterPresets` component allows users to save and load filter configurations.

## 7. KPI Configuration

The KPI panel interacts with the `kpi_metrics` table. Users can add a new KPI by specifying its name, description, calculation (as SQL or a reference to a view), and target. The API route `/app/api/marketing/kpi` handles insertion and retrieval. KPIs appear as cards using the `KpiCard` component.

## 8. Edge Functions (Optional)

If you need to synchronize data from external ad platforms (e.g., Google Ads, Facebook Ads), consider adding Supabase Edge Functions under `supabase/functions/marketing-sync`. Each function should authenticate with the external API, fetch data, and insert or update marketing tables. For example, a nightly function could pull the latest keyword performance metrics and populate `seo_sem_campaigns`.

## 9. Testing

* **Unit Testing:** Write tests for utility functions and API handlers using a testing framework like Jest. Mock Supabase client interactions using libraries such as `@supabase/supabase-js` test utilities.
* **Integration Testing:** Use the Supabase CLI to spin up a test database and apply migrations. Seed the database with test data. Write tests to ensure RLS policies and RBAC checks function as expected.
* **UI Testing:** Use Cypress or Playwright to automate end‑to‑end tests for form submission, filtering, and navigation across tabs.

## 10. Known Limitations & Future Work

See the final summary (`docs/marketing-v2-final-summary.md`) for a list of known limitations and potential enhancements.

---

This guide serves as a reference for developing and maintaining the marketing v2 module. It can be refined as new requirements emerge or the underlying data model evolves.